map $http_upgrade $connection_upgrade {
  default upgrade;
  ''      close;
}

server {
  listen 80;
  server_name localhost;
  resolver 127.0.0.11 ipv6=off;
  set $api_upstream api:5000;
  set $web_upstream web:5173;

  client_max_body_size 16m;

  # ---- API paths ----
  location ^~ /api/ {
    proxy_pass         http://$api_upstream;
    proxy_http_version 1.1;
    proxy_set_header   Host               $host;
    proxy_set_header   X-Real-IP          $remote_addr;
    proxy_set_header   X-Forwarded-For    $proxy_add_x_forwarded_for;
    proxy_set_header   X-Forwarded-Proto  $scheme;
    proxy_read_timeout 60s;
    proxy_send_timeout 60s;
  }

  location ^~ /auth/ {
    proxy_pass         http://$api_upstream;
    proxy_http_version 1.1;
    proxy_set_header   Host               $host;
    proxy_set_header   X-Real-IP          $remote_addr;
    proxy_set_header   X-Forwarded-For    $proxy_add_x_forwarded_for;
    proxy_set_header   X-Forwarded-Proto  $scheme;
    proxy_read_timeout 60s;
    proxy_send_timeout 60s;
  }

  # exact match for /me and /healthz
  location = /me {
    proxy_pass         http://$api_upstream;
    proxy_http_version 1.1;
    proxy_set_header   Host               $host;
    proxy_set_header   X-Real-IP          $remote_addr;
    proxy_set_header   X-Forwarded-For    $proxy_add_x_forwarded_for;
    proxy_set_header   X-Forwarded-Proto  $scheme;
    proxy_read_timeout 60s;
    proxy_send_timeout 60s;
  }

  location = /healthz {
    proxy_pass         http://$api_upstream;
    proxy_http_version 1.1;
    proxy_set_header   Host               $host;
    proxy_set_header   X-Real-IP          $remote_addr;
    proxy_set_header   X-Forwarded-For    $proxy_add_x_forwarded_for;
    proxy_set_header   X-Forwarded-Proto  $scheme;
    proxy_read_timeout 60s;
    proxy_send_timeout 60s;
  }

  # ---- Frontend (Vite dev server) ----
  location / {
    proxy_pass         http://$web_upstream;
    proxy_http_version 1.1;
    proxy_set_header   Host               $host;
    proxy_set_header   X-Real-IP          $remote_addr;
    proxy_set_header   X-Forwarded-For    $proxy_add_x_forwarded_for;
    proxy_set_header   X-Forwarded-Proto  $scheme;

    proxy_set_header   Upgrade            $http_upgrade;
    proxy_set_header   Connection         $connection_upgrade;

    proxy_read_timeout 300s;
    proxy_send_timeout 300s;
  }
}
